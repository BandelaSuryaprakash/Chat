package chatAppprocess;

import java.io.*;
import java.net.*;
import java.util.Collections;
import java.util.HashSet;
import java.util.Set;

public class Server {
	// ChatServer.java
	

	

	    private int port = 0;
	    private final Set<ClientHandler> clients = Collections.synchronizedSet(new HashSet<>());

	    public void ChatServer(int port) {
	        this.port = port;
	    }

	    public void start() {
	        System.out.println("Chat server starting on port " + port);
	        try (ServerSocket serverSocket = new ServerSocket(port)) {
	            System.out.println("Server started. Waiting for clients...");
	            while (true) {
	                Socket socket = serverSocket.accept();
	                System.out.println("New client connected: " + socket.getInetAddress());
	                ClientHandler clientHandler = new ClientHandler(socket, this);
	                clients.add(clientHandler);
	                new Thread(clientHandler).start();
	            }
	        } catch (IOException e) {
	            System.out.println("Error in server: " + e.getMessage());
	        }
	    }

	    void broadcast(String message, ClientHandler excludeClient) {
	        synchronized (clients) {
	            for (ClientHandler client : clients) {
	                if (client != excludeClient) {
	                    client.sendMessage(message);
	                }
	            }
	        }
	    }

	    void removeClient(ClientHandler clientHandler) {
	        clients.remove(clientHandler);
	        System.out.println("Client disconnected. Active clients: " + clients.size());
	    }

	    public static void main(String[] args) {
	        int port = 5000;
	        new Server().start();
	    }

	    // Inner class to handle each client
	    static class ClientHandler implements Runnable {
	        private Socket socket;
	        private Server server;
	        private PrintWriter out;
	        private BufferedReader in;
	        private String userName;

	        public ClientHandler(Socket socket, Server server) {
	            this.socket = socket;
	            this.server = server;
	        }

	        @Override
	        public void run() {
	            try {
	                in  = new BufferedReader(new InputStreamReader(socket.getInputStream()));
	                out = new PrintWriter(socket.getOutputStream(), true);

	                out.println("Enter your name:");
	                userName = in.readLine();
	                server.broadcast(userName + " joined the chat", this);
	                out.println("Welcome " + userName + "! Type 'exit' to leave.");

	                String message;
	                while ((message = in.readLine()) != null) {
	                    if ("exit".equalsIgnoreCase(message.trim())) {
	                        break;
	                    }
	                    String formatted = userName + ": " + message;
	                    System.out.println("Received: " + formatted);
	                    server.broadcast(formatted, this);
	                }
	            } catch (IOException e) {
	                System.out.println("Client error: " + e.getMessage());
	            } finally {
	                try {
	                    server.broadcast(userName + " left the chat", this);
	                    server.removeClient(this);
	                    if (socket != null) socket.close();
	                } catch (IOException ignored) {}
	            }
	        }

	        void sendMessage(String message) {
	            if (out != null) {
	                out.println(message);
	            }
	        }
	    }
	}



	
